<nb-card *ngIf="rola !== 'prodavnica' && rola !== 'uprava' && rola !== 'podrucni' && rola !== 'regionalni'"
  class="dashboard-card">
  <nb-card-header class="dashboard-header">
    <div class="header-content">
      <div class="header-icon">
        <nb-icon icon="flash-outline"></nb-icon>
      </div>
      <div class="header-copy">
        <span class="subtitle">Brzi pristup</span>
        <h2>Radna ploča</h2>
        <p>Centraliziran pregled ključnih operacija i najčešćih radnji.</p>
      </div>
    </div>
  </nb-card-header>

  <nb-card-body>
    <div class="section-heading">
      <div>
        <p class="eyebrow">Najčešće radnje</p>
        <h4 class="section-title">Organizovani prečaci</h4>
        <p class="muted">Odaberite jednu od ponuđenih akcija i brže dođite do željenih procesa.</p>
      </div>
    </div>

    <div class="quick-actions-grid">
      <nb-card *ngFor="let action of quickActions; trackBy: trackByAction" class="quick-action"
        [ngClass]="action.accent" (click)="onQuickAction(action.action)" (keyup.enter)="onQuickAction(action.action)"
        (keyup.space)="onQuickAction(action.action)" tabindex="0" role="button" [attr.aria-label]="action.title">

        <nb-card-body>
          <div class="quick-action-icon">
            <nb-icon [icon]="action.icon"></nb-icon>
          </div>

          <div class="quick-action-content">
            <h5>{{ action.title }}</h5>
            <p>{{ action.description }}</p>
          </div>

          <button nbButton status="primary" size="small" hero type="button"
            (click)="onQuickAction(action.action, $event)">
            <nb-icon icon="external-link-outline"></nb-icon>
            {{ action.cta }}
          </button>
        </nb-card-body>
      </nb-card>
    </div>
  </nb-card-body>
</nb-card>

<nb-card *ngIf="isRoleStoreDashboardVisible()" class="store-dashboard">
  <nb-card-header class="store-header">
    <div class="store-header-inner">
      <div class="store-title-block">
        <p class="eyebrow">Operativni pregled</p>
        <h2>
          <i class="fas fa-store"></i>
          Statistika prodavnice
        </h2>
        <small>Pratite ključne metrike i trendove u realnom vremenu.</small>
      </div>

      <div class="store-selector" *ngIf="rolesWithStoreSelection.includes(rola)">
        <p class="eyebrow">Izbor prodavnice</p>
        <div class="selector-row">
          <p-dropdown #storeDropdown class="store-dropdown" [options]="stores" [(ngModel)]="selectedStoreId"
            optionLabel="name" optionValue="code" [filter]="true" filterBy="name,code"
            placeholder="Izaberite prodavnicu" (onChange)="clearSearchAndSelect($event.value, storeDropdown)"
            appendTo="body">
          </p-dropdown>

          <div class="selector-hint" *ngIf="selectedStoreId && selectedStoreId !== '0000'">
            <b>Promet za: {{selectedStoreId}}</b>
          </div>
          <button nbButton status="info" size="small" class="all-network-btn"
            (click)="showAllStores(storeDropdown)">
            Prikaži cijelu mrežu
          </button>
        </div>
      </div>
    </div>
  </nb-card-header>
  <nb-card-body>
    <section class="store-rating" *ngIf="dashboardSummary">
      <div class="rating-card" tabindex="0">
        <div class="rating-main">
          <p class="eyebrow">{{ ratingTitle }}</p>
          <div class="rating-value-row">
            <span class="rating-number">{{ storeRating | number:'1.1-1' }}</span>
            <div class="rating-stars" aria-label="Grafička ocjena" title="Formula za ocjenu">
              <i *ngFor="let star of ratingStars" [class]="star"></i>
              <div class="rating-tooltip">
                <p><strong>Kako računamo ocjenu</strong></p>
                <ul>
                  <li *ngFor="let item of ratingBreakdown">{{ item }}</li>
                </ul>
              </div>
            </div>
          </div>
          <p class="muted rating-caption">{{ ratingCaption }}</p>
        </div>
        <div class="rating-highlights">
          <span class="rating-chip" [ngClass]="calcPercent(dashboardSummary.promet, dashboardSummary.prometProslaGodina) >= 0 ? 'positive' : 'negative'">
            <nb-icon [icon]="calcPercent(dashboardSummary.promet, dashboardSummary.prometProslaGodina) >= 0 ? 'trending-up' : 'trending-down'"></nb-icon>
            Promet {{ calcPercent(dashboardSummary.promet, dashboardSummary.prometProslaGodina) | number:'1.0-1' }}%
          </span>
          <span class="rating-chip" [ngClass]="calcPercent(dashboardSummary.averageBasket?.value, dashboardSummary.averageBasket?.previousValue) >= 0 ? 'positive' : 'negative'">
            <nb-icon [icon]="calcPercent(dashboardSummary.averageBasket?.value, dashboardSummary.averageBasket?.previousValue) >= 0 ? 'trending-up' : 'trending-down'"></nb-icon>
            Korpa {{ calcPercent(dashboardSummary.averageBasket?.value, dashboardSummary.averageBasket?.previousValue) | number:'1.0-1' }}%
          </span>
          <span class="rating-chip" [ngClass]="calcPercent(dashboardSummary.prometPoNetoKvadraturi, dashboardSummary.prometProslaGodinaPoNetoKvadraturi) >= 0 ? 'positive' : 'negative'">
            <nb-icon [icon]="calcPercent(dashboardSummary.prometPoNetoKvadraturi, dashboardSummary.prometProslaGodinaPoNetoKvadraturi) >= 0 ? 'home' : 'alert-triangle'"></nb-icon>
            Neto m² {{ calcPercent(dashboardSummary.prometPoNetoKvadraturi, dashboardSummary.prometProslaGodinaPoNetoKvadraturi) | number:'1.0-1' }}%
          </span>
        </div>
      </div>
    </section>
    <!-- KPI -->
    <section class="kpi-section">
      <div class="kpi-loading" *ngIf="isDashboardLoading">
        <nb-spinner size="large"></nb-spinner>
      </div>
      <div class="kpi-grid" *ngIf="!isDashboardLoading && dashboardSummary">
        <div class="kpi-card" *ngFor="let card of getKpiCards(); trackBy: trackByKpi" (click)="openKpiDetail(card.key)"
          [attr.aria-label]="card.label + ' ' + card.formattedValue + (card.unit ? ' ' + card.unit : '')">
          <span class="kpi-title">{{ card.label }}
            <nb-icon *ngIf="card.icon" [icon]="card.icon" status="primary" class="kpi-icon" size="large"></nb-icon>
          </span>
          <div class="kpi-support" *ngIf="card.supportText">{{ card.supportText }}</div>
          <div class="kpi-value">
            {{ card.formattedValue }}
            <small *ngIf="card.unit">{{ card.unit }}</small>
          </div>
          <div class="kpi-meta" *ngIf="card.previousValue !== undefined">
            <span>
              Prošle godine: {{ card.previousValue | number:'1.2-2' }}
              {{ card.unit ? ' ' + card.unit : '' }}
            </span>
            <br>
            <span [ngStyle]="{ 'color': card.delta >= 0 ? 'green' : 'red' }">
              Razlika:
              {{ card.deltaValue >= 0 ? '+' : ''}}{{ card.deltaValue | number:'1.2-2' }}
              {{ card.unit }}
              /
              {{ card.delta >= 0 ? '+' : ''}}{{ card.delta | number:'1.2-2' }}%
            </span>
          </div>
          <span class="kpi-hint">Kliknite za detalje</span>
        </div>
      </div>
    </section>

    <div class="charts-wrapper" [class.is-loading]="isStoreChartsLoading">
      <section class="chart-grid comparison-grid">
        <nb-card *ngFor="let chartItem of comparisonCharts; trackBy: trackByChart" class="chart-card">
          <nb-card-header>
            <div class="chart-header">
              <div class="icon-wrapper">
                <nb-icon [icon]="chartItem.icon"></nb-icon>
              </div>
              <div>
                <h5>{{ chartItem.title }}</h5>
                <small>{{ chartItem.description }}</small>
              </div>
            </div>
          </nb-card-header>

          <nb-card-body>
            <div class="chart-wrapper">
              <canvas [attr.id]="chartItem.id"></canvas>
            </div>
          </nb-card-body>
        </nb-card>
      </section>

      <div class="charts-loading" *ngIf="isStoreChartsLoading" aria-live="polite" role="status">
        <nb-spinner size="large"></nb-spinner>
        <p>Učitavanje vizualizacija...</p>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<ng-template #visitorsDetail>
  <nb-card>
    <nb-card-header>Trend posjetilaca</nb-card-header>
    <nb-card-body>
      <div class="modal-values" *ngIf="dashboardSummary">
        <p>Ove godine: {{ dashboardSummary.brojKupaca ?? dashboardSummary.visitors?.value ??
          dashboardSummary.visitors?.ukupno }}</p>
        <p>Prošle godine: {{ dashboardSummary.brojKupacaProslaGodina ?? dashboardSummary.visitors?.previousValue ??
          dashboardSummary.visitors?.prosla }}</p>
      </div>
      <div class="modal-chart">
        <canvas id="visitorsTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #turnoverDetail>
  <nb-card class="turnover-modal">
    <nb-card-header class="turnover-modal__header">
      Trend prometa
    </nb-card-header>

    <nb-card-body class="turnover-modal__body modal-body">
      <div class="modal-values" *ngIf="dashboardSummary">
        <p>
          Ove godine:
          {{ (dashboardSummary.promet ?? dashboardSummary.turnover?.value) | number:'1.2-2' }}
          {{ dashboardSummary.currency ?? 'KM' }}
        </p>
        <p>
          Prošle godine:
          {{ (dashboardSummary.prometProslaGodina ?? dashboardSummary.turnover?.previousValue) | number:'1.2-2' }}
          {{ dashboardSummary.currency ?? 'KM' }}
        </p>
      </div>

      <div class="modal-table" *ngIf="prometHistoryRows?.length; else prometHistoryState">
        <div class="modal-table__header">
          <div class="modal-table__copy">
            <p class="eyebrow">Historijski pregled</p>
          </div>

          <div class="modal-table__actions">

            <button nbButton size="small" status="success" 
                    (click)="exportPrometHistory()"
                    [disabled]="!prometHistoryRows?.length">
              <nb-icon icon="download-outline"></nb-icon>
              Preuzmi Excel
            </button>
          </div>
        </div>

        <div class="turnover-table__container">
          <table class="turnover-table">
            <thead>
              <tr>
                <th>Dan</th>
                <th>Trenutna godina ({{ prometHistoryRows[0]?.currentYear }})</th>
                <th>Prethodna godina ({{ prometHistoryRows[0]?.previousYear }})</th>
                <th>Razlika</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of paginatedPrometHistoryRows" [ngClass]="getPrometRowClass(row)">
                <td>
                  <div class="date-badge">
                    <span class="date-day">{{ row.currentYearDate | date:'dd' }}</span>
                    <span class="date-month">{{ row.currentYearDate | date:'MMM' }}</span>
                  </div>
                </td>
                <td class="numeric-cell">
                  {{ row.currentYearTurnover | number:'1.0-0' }}
                  {{ dashboardSummary?.currency ?? 'KM' }}
                </td>
                <td class="numeric-cell">
                  {{ row.previousYearTurnover | number:'1.0-0' }}
                  {{ dashboardSummary?.currency ?? 'KM' }}
                </td>
                <td class="delta-cell">
                  <span class="delta-chip" [ngClass]="getPrometRowClass(row)">
                    {{ row.difference | number:'1.0-0' }}
                    {{ dashboardSummary?.currency ?? 'KM' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="modal-pagination" *ngIf="prometHistoryRows.length > prometHistoryPageSize">
          <div class="pagination-meta">
            Stranica {{ prometHistoryPage }} od {{ totalPrometHistoryPages }}
          </div>

          <div class="pagination-actions">
            <button nbButton size="small" status="primary"
                    (click)="goToPrometHistoryPage('prev')"
                    [disabled]="prometHistoryPage === 1">
              <nb-icon icon="arrow-back-outline"></nb-icon>
              Prethodna
            </button>
            <button nbButton size="small" status="primary"
                    (click)="goToPrometHistoryPage('next')"
                    [disabled]="prometHistoryPage === totalPrometHistoryPages">
              Sljedeća
              <nb-icon icon="arrow-forward-outline"></nb-icon>
            </button>
          </div>
        </div>
      </div>

      <ng-template #prometHistoryState>
        <div class="modal-table placeholder" *ngIf="isPrometHistoryLoading; else prometHistoryEmpty">
          <nb-spinner size="medium"></nb-spinner>
          <p>Učitavanje historije prometa...</p>
        </div>
        <ng-template #prometHistoryEmpty>
          <p class="muted">Nema podataka za odabrani period.</p>
        </ng-template>
      </ng-template>
    </nb-card-body>
  </nb-card>
</ng-template>



<ng-template #shrinkageDetail>
  <nb-card>
    <nb-card-header>Trend otpisa</nb-card-header>
    <nb-card-body>
      <div class="modal-chart">
        <canvas id="shrinkageTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #basketDetail>
  <nb-card>
    <nb-card-header>Prosječna vrijednost korpe</nb-card-header>
    <nb-card-body>
      <div class="modal-chart">
        <canvas id="basketTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #categoryDetail>
  <nb-card class="category-share-modal">
    <nb-card-header>Udio kategorija u prodaji</nb-card-header>
    <nb-card-body class="category-share-modal__body">
      <div class="category-share__layout">
        <div class="category-share__controls">
          <div class="category-share__summary">
            <p class="eyebrow">Odabrane kategorije</p>
            <h3>{{ categoryShareValue | number: '1.1-1' }}%</h3>
            <p class="muted">Trenutno koristimo privremene podatke dok se ne poveže stvarni izvor.</p>
          </div>
          <div class="category-share__list">
            <label class="category-share__item" *ngFor="let category of categoryOptions">
              <input type="checkbox" [checked]="selectedCategories.includes(category.category)"
                (change)="toggleCategorySelection(category.category, $event.target.checked)" />
              <div class="category-share__copy">
                <span class="category-share__name">{{ category.category }}</span>
                <small>{{ (category.share * 100) | number: '1.0-1' }}% / {{ category.promet | number:'1.0-0' }} KM</small>
              </div>
            </label>
          </div>
        </div>

        <div class="modal-chart">
          <canvas id="categoryShareChart"></canvas>
        </div>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<div *ngIf="this.rola =='uprava'" class="data-section">
  <div class="section-heading data-heading">
    <div>
      <p class="eyebrow">Detaljni pregled</p>
      <h3 class="section-title">Prometi prodavnica</h3>
      <p class="muted">Filtrirajte i prilagodite kolone prije izvoza ili daljnje analize.</p>
    </div>
    <div class="section-actions">
      <button nbButton size="small" status="primary" (click)="showColumnSettings = !showColumnSettings">
        <nb-icon icon="settings-2"></nb-icon> Kolone
      </button>
      <button nbButton size="small" status="success" (click)="preuzmiExcel()">
        <nb-icon icon="download"></nb-icon> Excel
      </button>
    </div>
  </div>

  <nb-alert *ngIf="isManagementBootstrapLoading" status="info" class="loading-banner">
    <div class="loading-banner__copy">
      <nb-icon icon="loader-outline"></nb-icon>
      <div>
        <strong>Pripremamo mrežu prodavnica</strong>
        <p>Podaci se učitavaju u pozadini. Možete nastaviti pregled čim tabela postane dostupna.</p>
      </div>
    </div>
  </nb-alert>

  <div class="range-filter-card">
    <div class="range-filter-header">
      <div>
        <p class="eyebrow">Opseg datuma</p>
        <h4 class="section-title">Usporedba tekuće i prošle godine</h4>
        <p class="muted">Odaberite intervale i automatski ćemo povući podatke za obje godine.</p>
      </div>
      <div class="range-actions">
        <button nbButton size="small" status="basic" (click)="toggleRangeFilter()">
          <nb-icon [icon]="isRangeFilterOpen ? 'chevron-up' : 'chevron-down'"></nb-icon>
          {{ isRangeFilterOpen ? 'Sakrij unos' : 'Prikaži unos' }}
        </button>
        <button nbButton size="small" status="info" (click)="syncPreviousRangeWithCurrent()" [disabled]="!isRangeFilterOpen">
          <nb-icon icon="flip-outline"></nb-icon>
          Uskladi prošlu godinu
        </button>
        <nb-spinner *ngIf="isRangeLoading" size="small"></nb-spinner>
      </div>
    </div>

    <div class="range-grid" *ngIf="isRangeFilterOpen">
      <div class="range-column">
        <h5>Tekuća godina</h5>
        <label>Od</label>
        <input nbInput fullWidth type="date" [(ngModel)]="currentRangeStart" (change)="onCurrentRangeChange()" />
        <label>Do</label>
        <input nbInput fullWidth type="date" [(ngModel)]="currentRangeEnd" (change)="onCurrentRangeChange()" />
      </div>
      <div class="range-column">
        <h5>Prošla godina</h5>
        <label>Od</label>
        <input nbInput fullWidth type="date" [(ngModel)]="previousRangeStart" (change)="onPreviousRangeChange()" />
        <label>Do</label>
        <input nbInput fullWidth type="date" [(ngModel)]="previousRangeEnd" (change)="onPreviousRangeChange()" />
      </div>

      <div class="range-column range-summary-card" *ngIf="prometRangeTotals">
        <p class="eyebrow">Sumarno</p>
        <h5>Ukupni promet: {{ prometRangeTotals?.promet | number:'1.0-0' }} KM</h5>
        <p class="muted">Promet PG: {{ prometRangeTotals?.prometProslaGodina | number:'1.0-0' }} KM</p>
        <div class="delta-row" *ngIf="prometRangeTotals">
          <span class="delta-chip" [ngClass]="{'positive': getRangeDelta(prometRangeTotals?.promet, prometRangeTotals?.prometProslaGodina) >= 0, 'negative': getRangeDelta(prometRangeTotals?.promet, prometRangeTotals?.prometProslaGodina) < 0}">
            {{ getRangeDelta(prometRangeTotals?.promet, prometRangeTotals?.prometProslaGodina) | number:'1.0-0' }} KM
            ({{ getRangeDeltaPercent(prometRangeTotals?.promet, prometRangeTotals?.prometProslaGodina) | number:'1.0-2' }}%)
          </span>
        </div>
        <div class="summary-row">
          <small>Kupci: {{ prometRangeTotals?.brojKupaca | number:'1.0-0' }} / PG {{ prometRangeTotals?.brojKupacaProslaGodina | number:'1.0-0' }}</small>
        </div>
      </div>
    </div>
  </div>

  <div class="filter-row" [class.is-disabled]="isManagementBootstrapLoading">
    <nb-toggle id="toggleSelectAll" class="tiny-toggle" status="info" [checked]="allSelected"
      (checkedChange)="toggleAllColumns($event)" labelPosition="right">
      <nb-icon icon="list" status="info"></nb-icon> Sve kolone
    </nb-toggle>

    <nb-toggle status="success" class="tiny-toggle" size="small" [checked]="positiveFilterActive"
      (checkedChange)="onPositiveToggleChange($event)" labelPosition="right">
      <nb-icon icon="trending-up" status="success"></nb-icon> Pozitivni promet
    </nb-toggle>

    <nb-toggle status="danger" class="tiny-toggle" [checked]="negativeFilterActive"
      (checkedChange)="onNegativeToggleChange($event)" labelPosition="right">
      <nb-icon icon="trending-down" status="danger"></nb-icon> Negativni promet
    </nb-toggle>

    <button nbButton size="tiny" status="warning" (click)="resetFilter()">
      <nb-icon icon="sync"></nb-icon> Reset filtera
    </button>
  </div>

  <div *ngIf="showColumnSettings" class="settings-panel wow-panel">
    <div class="columns-checkboxes">
      <div class="row" *ngFor="let row of columnRows">
        <label *ngFor="let col of row" class="column-checkbox">
          <input type="checkbox" [checked]="!settings.columns[col].hide"
            (change)="toggleColumn(col, $event.target.checked)" />
          <span class="checkmark"></span>
          {{ settings.columns[col].title }}
        </label>
      </div>
    </div>
  </div>

  <div class="table-wrapper" [class.is-loading]="isManagementBootstrapLoading">
    <div class="table-loader" *ngIf="isManagementBootstrapLoading" aria-live="polite">
      <nb-spinner size="large"></nb-spinner>
      <p>Brzo balansiramo učitavanje, podaci stižu za trenutak...</p>
    </div>
    <ng2-smart-table [settings]="settings" [source]="source" [attr.aria-busy]="isManagementBootstrapLoading"></ng2-smart-table>
  </div>

  <div *ngIf="prometRangeDays.length" class="range-day-table">
    <div class="section-heading data-heading">
      <div>
        <p class="eyebrow">Sumarno po danu</p>
        <h3 class="section-title">Pregled po datumima</h3>
        <p class="muted">Vidite ukupne promete i broj kupaca za svaki dan izabranog opsega.</p>
      </div>
    </div>

    <div class="day-table-wrapper">
      <table class="range-table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Promet</th>
            <th>Promet PG</th>
            <th>Kupci</th>
            <th>Kupci PG</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let day of prometRangeDays">
            <td>{{ day.datum | date:'dd.MM.yyyy' }}</td>
            <td>{{ day.promet | number:'1.0-0' }} KM</td>
            <td>{{ day.prometProslaGodina | number:'1.0-0' }} KM</td>
            <td>{{ day.brojKupaca | number:'1.0-0' }}</td>
            <td>{{ day.brojKupacaProslaGodina | number:'1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
