<!-- ========================= -->
<!-- DASHBOARD – INTERNI / PODRUČNI / REGIONALNI -->
<!-- ========================= -->
<nb-card *ngIf="rola !== 'prodavnica' && rola !== 'uprava' && rola !== 'podrucni' && rola !== 'regionalni'" class="dashboard-card">
  <nb-card-header class="dashboard-header">
    <div class="header-content">
      <div class="header-icon">
        <nb-icon icon="flash-outline"></nb-icon>
      </div>
      <div class="header-copy">
        <span class="subtitle">Brzi pristup</span>
        <h2>Radna ploča</h2>
        <p>Centraliziran pregled ključnih operacija i najčešćih radnji.</p>
      </div>
    </div>
  </nb-card-header>

  <nb-card-body>
    <div class="quick-actions-grid">
      <nb-card
        *ngFor="let action of quickActions; trackBy: trackByAction"
        class="quick-action"
        [ngClass]="action.accent"
        (click)="onQuickAction(action.action)"
        (keyup.enter)="onQuickAction(action.action)"
        (keyup.space)="onQuickAction(action.action)"
        tabindex="0"
        role="button"
        [attr.aria-label]="action.title">

        <nb-card-body>
          <div class="quick-action-icon">
            <nb-icon [icon]="action.icon"></nb-icon>
          </div>

          <div class="quick-action-content">
            <h5>{{ action.title }}</h5>
            <p>{{ action.description }}</p>
          </div>

          <button
            nbButton
            status="primary"
            size="small"
            hero
            type="button"
            (click)="onQuickAction(action.action, $event)">
            <nb-icon icon="external-link-outline"></nb-icon>
            {{ action.cta }}
          </button>
        </nb-card-body>
      </nb-card>
    </div>
  </nb-card-body>
</nb-card>



<!-- ========================= -->
<!-- DASHBOARD – PRODAVNICA / UPRAVA / PODRUČNI / REGIONALNI -->
<!-- ========================= -->

<!-- Prikaži store-dashboard ako je rola prodavnica ili ako rola spada u set koji može birati prodavnicu -->
<nb-card *ngIf="isRoleStoreDashboardVisible()" class="store-dashboard">

  <nb-card-header class="store-header text-center">
    <div class="store-header-inner">
      <div>
        <h2>
          <nb-icon icon="activity"></nb-icon>
          Statistika prodavnice
        </h2>
        <small>Pratite ključne metrike i trendove u realnom vremenu.</small>
      </div>

      <!-- Dropdown za uprava/podrucni/regionalni -->
      <div class="store-selector" *ngIf="rolesWithStoreSelection.includes(rola)">
        <nb-select placeholder="Izaberite prodavnicu"
                   [(selected)]="selectedStoreId"
                   (selectedChange)="onStoreChange($event)">
          <nb-option *ngFor="let s of stores" [value]="s.id ?? s.brojProdavnice ?? s.storeId">
            {{ s.brojProdavnice ? (s.brojProdavnice + ' - ') : '' }}{{ s.adresa || s.naziv }}
          </nb-option>
        </nb-select>
      </div>
    </div>
  </nb-card-header>

  <nb-card-body>

    <!-- KPI SECTION -->
    <section class="kpi-section">
      <div class="kpi-loading" *ngIf="isDashboardLoading">
        <nb-spinner size="large"></nb-spinner>
      </div>

      <div class="kpi-grid" *ngIf="!isDashboardLoading && dashboardSummary">
        <div
          class="kpi-card"
          *ngFor="let card of getKpiCards(); trackBy: trackByKpi"
          (click)="openKpiDetail(card.key)"
          [attr.aria-label]="card.label + ' ' + card.formattedValue + (card.unit ? ' ' + card.unit : '')">

          <span class="kpi-title">{{ card.label }}</span>

          <div class="kpi-value">
            {{ card.formattedValue }}
            <small *ngIf="card.unit">{{ card.unit }}</small>
          </div>

          <div class="kpi-meta" *ngIf="card.previousValue !== undefined || card.delta !== undefined">
            <span *ngIf="card.previousValue !== undefined">Prošle godine: {{ card.previousValue | number:'1.0-2' }}{{ card.unit ? ' ' + card.unit : '' }}</span> 
            <br>
            <span *ngIf="card.delta !== undefined">Promjena: {{ card.delta >= 0 ? '+' : ''}}{{ card.delta | number:'1.0-2' }}%</span>
          </div>

          <span class="kpi-hint">Kliknite za detalje</span>
        </div>
      </div>
    </section>

    <!-- CHARTS -->
    <div class="charts-wrapper" [class.is-loading]="isStoreChartsLoading">
      <section class="chart-grid comparison-grid">
        <nb-card
          *ngFor="let chartItem of comparisonCharts; trackBy: trackByChart"
          class="chart-card">

          <nb-card-header>
            <div class="chart-header">
              <div class="icon-wrapper">
                <nb-icon [icon]="chartItem.icon"></nb-icon>
              </div>

              <div>
                <h5>{{ chartItem.title }}</h5>
                <small>{{ chartItem.description }}</small>
              </div>
            </div>
          </nb-card-header>

          <nb-card-body>
            <div class="chart-wrapper">
              <canvas [attr.id]="chartItem.id"></canvas>
            </div>
          </nb-card-body>
        </nb-card>
      </section>

      <div class="charts-loading" *ngIf="isStoreChartsLoading" aria-live="polite" role="status">
        <nb-spinner size="large"></nb-spinner>
        <p>Učitavanje vizualizacija...</p>
      </div>
    </div>
  </nb-card-body>
</nb-card>



<!-- ========================= -->
<!-- MODAL TEMPLATES -->
<!-- ========================= -->

<ng-template #visitorsDetail>
  <nb-card>
    <nb-card-header>Trend posjetilaca</nb-card-header>
    <nb-card-body>
      <div class="modal-values" *ngIf="dashboardSummary">
        <p>Ove godine: {{ dashboardSummary.brojKupaca ?? dashboardSummary.visitors?.value ?? dashboardSummary.visitors?.ukupno }}</p>
        <p>Prošle godine: {{ dashboardSummary.brojKupacaProslaGodina ?? dashboardSummary.visitors?.previousValue ?? dashboardSummary.visitors?.prosla }}</p>
      </div>
      <div class="modal-chart">
        <canvas id="visitorsTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #turnoverDetail>
  <nb-card>
    <nb-card-header>Trend prometa</nb-card-header>
    <nb-card-body>
      <div class="modal-values" *ngIf="dashboardSummary">
        <p>Ove godine: {{ (dashboardSummary.promet ?? dashboardSummary.turnover?.value) | number:'1.0-2' }} {{ dashboardSummary.currency ?? 'KM' }}</p>
        <p>Prošle godine: {{ (dashboardSummary.prometProslaGodina ?? dashboardSummary.turnover?.previousValue) | number:'1.0-2' }} {{ dashboardSummary.currency ?? 'KM' }}</p>
      </div>
      <div class="modal-chart">
        <canvas id="turnoverTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #shrinkageDetail>
  <nb-card>
    <nb-card-header>Trend otpisa</nb-card-header>
    <nb-card-body>
      <div class="modal-chart">
        <canvas id="shrinkageTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #basketDetail>
  <nb-card>
    <nb-card-header>Prosječna vrijednost korpe</nb-card-header>
    <nb-card-body>
      <div class="modal-chart">
        <canvas id="basketTrendChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #categoryDetail>
  <nb-card>
    <nb-card-header>Udio kategorija u prodaji</nb-card-header>
    <nb-card-body>
      <div class="modal-chart">
        <canvas id="categoryShareChart"></canvas>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>
