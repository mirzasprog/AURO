<nb-card class="editor-card">
  <nb-card-header>
    <div class="editor-header">
      <span>Grafički editor layouta</span>
      <div class="actions">
        <button nbButton size="small" status="primary" (click)="sacuvaj()">Sačuvaj</button>
      </div>
    </div>
  </nb-card-header>
  <nb-card-body>
    <div class="editor-grid">
      <div class="canvas-panel">
        <div class="canvas-viewport" #canvas (mousedown)="onCanvasMouseDown($event)">
          <div class="canvas-pan" [ngStyle]="getPanStyle()">
            <div class="canvas-content" [ngStyle]="getCanvasStyle()">
              <div
                class="background-layer"
                *ngIf="layout.backgroundData && isImageBackground()"
                [ngStyle]="getBackgroundStyle()"
              ></div>
              <div
                class="layout-item"
                *ngFor="let item of prikazanePozicije"
                [class.selected]="selectedIndex === item.index"
                [class.invalid]="isOutOfBounds(item.pozicija) || isOverlapping(item.index)"
                [ngStyle]="getPozicijaStyle(item.pozicija)"
                [nbTooltip]="getPozicijaTooltip(item.pozicija)"
                nbTooltipPlacement="top"
                (mousedown)="onMouseDown($event, item.index)"
                (click)="otvoriDetalje(item.index)"
              >
                <span>{{ getPozicijaLabel(item.pozicija) }}</span>
                <div class="resize-handle" (mousedown)="onResizeMouseDown($event, item.index)"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="canvas-info">
          <p>Prevlačenjem praznog prostora pomjerate cijeli layout. Validacija preklapanja koristi osnovne okvire bez rotacije.</p>
        </div>
      </div>
      <div class="options-panel">
        <div class="left-panel">
          <div class="add-object">
            <label>Dodaj objekat</label>
            <nb-select [(ngModel)]="odabraniTip">
              <nb-option *ngFor="let tip of tipovi" [value]="tip">{{ tip.label }}</nb-option>
            </nb-select>
            <button nbButton status="success" (click)="otvoriModalZaDodavanje()">
              <nb-icon icon="plus-outline"></nb-icon>
              Dodaj poziciju
            </button>
          </div>

          <div class="filters-panel">
            <label>Dobavljač</label>
            <nb-select multiple [(ngModel)]="odabraniDobavljaci">
              <nb-option *ngFor="let dobavljac of dostupniDobavljaci" [value]="dobavljac">
                {{ dobavljac }}
              </nb-option>
            </nb-select>
            <label class="toggle">
              <input type="checkbox" [(ngModel)]="filtrirajUskoro" />
              <span>Ugovor ističe uskoro ({{ pragDanaIsteka }} dana)</span>
            </label>
          </div>

          <div class="warnings" *ngIf="warnings.length">
            <h6>Upozorenja</h6>
            <ul>
              <li *ngFor="let warning of warnings">{{ warning }}</li>
            </ul>
          </div>
        </div>

        <div class="right-panel">
          <div class="tools-panel">
            <div class="background-upload">
              <label>Podloga (JPEG/DWG)</label>
              <input #backgroundInput type="file" accept=".jpg,.jpeg,.dwg" (change)="onBackgroundSelected($event)" />
              <button nbButton status="info" outline (click)="triggerBackgroundUpload()">
                <nb-icon icon="image-outline"></nb-icon>
                Učitaj podlogu
              </button>
              <div class="background-meta" *ngIf="layout.backgroundFileName">
                <span>{{ layout.backgroundFileName }}</span>
                <button nbButton size="tiny" status="danger" outline (click)="ukloniPodlogu()">Ukloni</button>
              </div>
              <div class="background-rotation" *ngIf="layout.backgroundData && isImageBackground()">
                <label>Rotacija podloge (°)</label>
                <input type="range" min="-180" max="180" step="5" [(ngModel)]="layout.backgroundRotation" />
                <div class="rotation-actions">
                  <button nbButton size="tiny" status="basic" (click)="rotirajPodlogu(-90)">-90°</button>
                  <button nbButton size="tiny" status="basic" (click)="rotirajPodlogu(90)">+90°</button>
                </div>
              </div>
              <p class="hint" *ngIf="layout.backgroundFileName && !isImageBackground()">DWG podloga se čuva, ali nije moguće prikazati pregled.</p>
            </div>

            <div class="zoom-controls">
              <label>Zoom</label>
              <div class="zoom-actions">
                <button nbButton size="tiny" status="basic" (click)="zoomOut()">-</button>
                <input type="range" [min]="minZoom" [max]="maxZoom" step="0.1" [(ngModel)]="zoom" (ngModelChange)="onZoomChange($event)" />
                <button nbButton size="tiny" status="basic" (click)="zoomIn()">+</button>
                <span>{{ zoom * 100 | number:'1.0-0' }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<div class="modal-backdrop" *ngIf="isDodavanjeModalOpen">
  <nb-card class="modal-card">
    <nb-card-header>Dodaj poziciju</nb-card-header>
    <nb-card-body>
      <div class="modal-form">
        <label>Tip pozicije</label>
        <nb-select [(ngModel)]="novaPozicija.tip">
          <nb-option *ngFor="let tip of tipovi" [value]="tip.value">{{ tip.label }}</nb-option>
        </nb-select>
        <label>Naziv</label>
        <input nbInput [(ngModel)]="novaPozicija.naziv" />
        <label>Broj pozicije</label>
        <input nbInput [(ngModel)]="novaPozicija.brojPozicije" />
        <label>Odjel</label>
        <nb-select [(ngModel)]="novaPozicija.zona">
          <nb-option *ngFor="let odjel of odjeli" [value]="odjel">{{ odjel }}</nb-option>
        </nb-select>
      </div>
    </nb-card-body>
    <nb-card-footer class="modal-actions">
      <button nbButton status="basic" outline (click)="zatvoriModalZaDodavanje()">Odustani</button>
      <button nbButton status="success" (click)="potvrdiDodavanje()">Dodaj</button>
    </nb-card-footer>
  </nb-card>
</div>

<div class="modal-backdrop" *ngIf="isDetaljiModalOpen && selectedIndex !== null">
  <nb-card class="modal-card">
    <nb-card-header>
      <div class="modal-header">
        <span>Detalji pozicije</span>
        <button nbButton size="tiny" status="basic" outline (click)="zatvoriDetalje()">Zatvori</button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="modal-form" *ngIf="selectedIndex !== null">
        <label>Broj pozicije</label>
        <input nbInput [(ngModel)]="pozicije[selectedIndex].brojPozicije" />
        <label>Tip</label>
        <nb-select [(ngModel)]="pozicije[selectedIndex].tip" (selectedChange)="azurirajUpozorenja()">
          <nb-option *ngFor="let tip of tipovi" [value]="tip.value">{{ tip.label }}</nb-option>
        </nb-select>
        <label>Naziv/Oznaka</label>
        <input nbInput [(ngModel)]="pozicije[selectedIndex].naziv" (ngModelChange)="azurirajUpozorenja()" />
        <label>Trgovac</label>
        <input nbInput [(ngModel)]="pozicije[selectedIndex].trgovac" />
        <label>Zakup do</label>
        <input nbInput type="date" [(ngModel)]="pozicije[selectedIndex].zakupDo" />
        <label>Vrijednost zakupa (KM)</label>
        <input nbInput type="number" [(ngModel)]="pozicije[selectedIndex].vrijednostZakupa" min="0" step="0.01" />
        <label>Vrsta ugovora</label>
        <nb-select [(ngModel)]="pozicije[selectedIndex].vrstaUgovora">
          <nb-option *ngFor="let vrsta of vrsteUgovora" [value]="vrsta">{{ vrsta }}</nb-option>
        </nb-select>
        <label>Tip pozicije (oprema)</label>
        <nb-select [(ngModel)]="pozicije[selectedIndex].tipPozicije">
          <nb-option *ngFor="let tip of tipoviPozicije" [value]="tip">{{ tip }}</nb-option>
        </nb-select>
        <label>Odjel</label>
        <nb-select [(ngModel)]="pozicije[selectedIndex].zona">
          <nb-option *ngFor="let odjel of odjeli" [value]="odjel">{{ odjel }}</nb-option>
        </nb-select>
        <div class="detail-actions">
          <button nbButton status="info" outline (click)="kopirajPoziciju()">
            <nb-icon icon="copy-outline"></nb-icon>
            Kopiraj
          </button>
          <button nbButton status="danger" outline (click)="obrisiPoziciju()">
            <nb-icon icon="trash-2-outline"></nb-icon>
            Obriši
          </button>
        </div>
      </div>
    </nb-card-body>
  </nb-card>
</div>
