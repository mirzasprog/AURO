<nb-card class="daily-card">
  <nb-card-header class="page-header">
    <div class="headline">
      <div>
        <span class="subtitle">{{ headlineDate | titlecase }}</span>
        <h2>Dnevni zadaci</h2>
      </div>
      <div class="store-select" *ngIf="canManageStores">
        <nb-select placeholder="Odaberite prodavnicu" [(selected)]="selectedStoreId" (selectedChange)="onStoreChange()">
          <nb-option *ngFor="let store of stores" [value]="store.id">{{ store.name }}</nb-option>
        </nb-select>
      </div>
      <div class="store-badge" *ngIf="!canManageStores && rola.name">
        <nb-icon icon="pin-outline"></nb-icon>
        <span>Prodavnica {{ rola.name }}</span>
      </div>
    </div>
    <button nbButton status="primary" size="small" hero class="create-btn"
            *ngIf="canCreateCustomTasks"
            [disabled]="canManageStores && !selectedStoreId"
            (click)="createCustomTask()">
      <nb-icon icon="plus-outline"></nb-icon>
      Novi zadatak
    </button>
  </nb-card-header>
  <nb-card-body>
    <div class="loading" *ngIf="loading">
      <nb-spinner size="giant"></nb-spinner>
    </div>

    <ng-container *ngIf="!loading">
      <div class="kpi-grid" *ngIf="summaryCards.length">
        <nb-card *ngFor="let card of summaryCards" class="kpi-card" [ngClass]="card.accent">
          <nb-card-body>
            <div class="kpi-icon">
              <nb-icon [icon]="card.icon"></nb-icon>
            </div>
            <div class="kpi-content">
              <span class="kpi-title">{{ card.title }}</span>
              <h3>{{ card.value }}</h3>
              <small>{{ card.subtitle }}</small>
            </div>
          </nb-card-body>
        </nb-card>
      </div>

      <div class="visual-grid" *ngIf="statusChartData.length">
        <nb-card class="chart-card">
          <nb-card-header>
            <div>
              <h5>Status zadataka</h5>
              <small>Brzi pregled prema trenutnom statusu</small>
            </div>
          </nb-card-header>
          <nb-card-body>
            <ngx-charts-pie-chart
              [results]="statusChartData"
              [scheme]="statusChartColorScheme"
              [gradient]="chartGradient"
              [legend]="false"
              [labels]="chartShowLabels"
              [doughnut]="chartDoughnut">
            </ngx-charts-pie-chart>
          </nb-card-body>
        </nb-card>

        <nb-card class="insight-card" *ngIf="canCreateCustomTasks">
          <nb-card-body>
            <h5>Kreirajte vlastiti ritam</h5>
            <p>Dodajte personalni zadatak i odaberite da li će se ponavljati svakodnevno ili samo jednom.</p>
            <button nbButton size="small" status="info" (click)="createCustomTask()"
                    [disabled]="canManageStores && !selectedStoreId">
              <nb-icon icon="calendar-outline"></nb-icon>
              Kreiraj zadatak
            </button>
          </nb-card-body>
        </nb-card>
      </div>

      <div class="empty-state" *ngIf="!hasTasks && isStoreSelected">
        <nb-icon icon="clipboard-outline"></nb-icon>
        <p>Još uvijek nema zadataka za današnji dan. Dodajte prvi zadatak i postavite ton dana!</p>
      </div>

      <div class="board" *ngIf="hasTasks">
        <section class="board-column">
          <header class="column-header">
            <div class="icon-wrapper primary"><nb-icon icon="sync-outline"></nb-icon></div>
            <div>
              <h5>Ponavljajući zadaci</h5>
              <small>{{ repetitiveTasks.length }} zadataka</small>
            </div>
          </header>
          <div class="task-list" *ngIf="repetitiveTasks.length; else noRecurring">
            <nb-card *ngFor="let task of repetitiveTasks; trackBy: trackByTaskId" class="task-tile clickable" (click)="openTask(task)">
              <nb-card-body>
                <div class="task-headline">
                  <span class="task-name">{{ task.title }}</span>
                  <nb-badge [text]="task.status | titlecase"
                            [status]="task.status === 'DONE' ? 'success' : task.status === 'IN_PROGRESS' ? 'info' : 'warning'">
                  </nb-badge>
                </div>
                <p class="task-description" *ngIf="task.description">{{ task.description }}</p>
                <div class="task-tags">
                  <nb-tag appearance="filled" status="primary">Dnevna rutina</nb-tag>
                  <nb-tag *ngIf="task.isRecurring" appearance="outline" status="info">Personalizovano</nb-tag>
                  <nb-tag *ngIf="task.imageAllowed" appearance="outline" status="basic">
                    <nb-icon icon="image-outline"></nb-icon> Slika dozvoljena
                  </nb-tag>
                </div>
                <div class="task-meta">
                  <span *ngIf="task.completedAt">Završeno: {{ task.completedAt | date:'short' }}</span>
                </div>
              </nb-card-body>
            </nb-card>
          </div>
          <ng-template #noRecurring>
            <div class="column-empty">
              <p>Nema ponavljajućih zadataka. Dodajte zadatak i označite ga kao ponavljajući.</p>
            </div>
          </ng-template>
        </section>

        <section class="board-column">
          <header class="column-header">
            <div class="icon-wrapper success"><nb-icon icon="list-outline"></nb-icon></div>
            <div>
              <h5>Jednokratni zadaci</h5>
              <small>{{ customTasks.length }} zadataka</small>
            </div>
          </header>
          <div class="task-list" *ngIf="customTasks.length; else noCustom">
            <nb-card *ngFor="let task of customTasks; trackBy: trackByTaskId" class="task-tile">
              <nb-card-body>
                <div class="task-headline">
                  <span class="task-name">{{ task.title }}</span>
                  <div class="task-actions">
                    <nb-badge [text]="task.status | titlecase"
                              [status]="task.status === 'DONE' ? 'success' : task.status === 'IN_PROGRESS' ? 'info' : 'warning'">
                    </nb-badge>
                    <button nbButton ghost size="tiny" nbTooltip="Prikaži" (click)="openTask(task)">
                      <nb-icon icon="eye-outline"></nb-icon>
                    </button>
                    <button nbButton ghost size="tiny" nbTooltip="Uredi"
                            *ngIf="task.isEditable && canCreateCustomTasks"
                            (click)="editCustomTask(task); $event.stopPropagation();">
                      <nb-icon icon="edit-2-outline"></nb-icon>
                    </button>
                  </div>
                </div>
                <p class="task-description" *ngIf="task.description">{{ task.description }}</p>
                <div class="task-meta">
                  <span *ngIf="task.createdBy">Kreirao: {{ task.createdBy }}</span>
                  <span *ngIf="task.completedBy">Završio: {{ task.completedBy }}</span>
                </div>
                <div class="task-meta">
                  <span *ngIf="task.completedAt">Završeno: {{ task.completedAt | date:'short' }}</span>
                </div>
              </nb-card-body>
            </nb-card>
          </div>
          <ng-template #noCustom>
            <div class="column-empty">
              <p>Kreirajte prvi jednokratni zadatak i fokusirajte se na specifične aktivnosti dana.</p>
            </div>
          </ng-template>
        </section>
      </div>

      <section class="history-section">
        <div class="history-header">
          <div>
            <h4>Pregled prethodnih zadataka</h4>
            <small *ngIf="canManageStores">Pregled na nivou mreže ili filtrirajte po prodavnici.</small>
            <small *ngIf="!canManageStores">Pregled vaših ranije evidentiranih zadataka.</small>
          </div>
          <div class="history-actions">
            <button nbButton size="small" status="primary" (click)="downloadReport()" [disabled]="historyLoading || reportLoading">
              <nb-icon icon="download-outline"></nb-icon>
              Preuzmi report
            </button>
          </div>
        </div>

        <div class="history-filters">
          <div class="filter" *ngIf="canManageStores">
            <label>Prodavnica</label>
            <nb-select fullWidth [(selected)]="historyStoreId" (selectedChange)="refreshHistory()">
              <nb-option [value]="null">Sve prodavnice</nb-option>
              <nb-option *ngFor="let store of stores" [value]="store.id">{{ store.name }}</nb-option>
            </nb-select>
          </div>
          <div class="filter">
            <label>Od</label>
            <input nbInput type="date" [(ngModel)]="historyFrom" (ngModelChange)="refreshHistory()">
          </div>
          <div class="filter">
            <label>Do</label>
            <input nbInput type="date" [(ngModel)]="historyTo" (ngModelChange)="refreshHistory()">
          </div>
          <div class="filter">
            <label>Status</label>
            <nb-select fullWidth [(selected)]="historyStatus" (selectedChange)="refreshHistory()">
              <nb-option value="DONE">Završeni</nb-option>
              <nb-option value="IN_PROGRESS">U toku</nb-option>
              <nb-option value="OPEN">Otvoreni</nb-option>
              <nb-option value="ALL">Svi</nb-option>
            </nb-select>
          </div>
          <div class="filter">
            <label>Tip</label>
            <nb-select fullWidth [(selected)]="historyType" (selectedChange)="refreshHistory()">
              <nb-option value="ALL">Svi</nb-option>
              <nb-option value="REPETITIVE">Ponavljajući</nb-option>
              <nb-option value="CUSTOM">Jednokratni</nb-option>
            </nb-select>
          </div>
        </div>

        <div class="history-body">
          <div class="loading" *ngIf="historyLoading">
            <nb-spinner size="giant"></nb-spinner>
          </div>
          <div class="empty-state" *ngIf="!historyLoading && !hasHistoryTasks">
            <nb-icon icon="archive-outline"></nb-icon>
            <p>Nema zadataka za odabrani period. Promijenite filtere ili odaberite drugi period.</p>
          </div>
          <div class="history-table" *ngIf="!historyLoading && hasHistoryTasks">
            <table>
              <thead>
                <tr>
                  <th>Datum</th>
                  <th *ngIf="canManageStores">Prodavnica</th>
                  <th>Zadatak</th>
                  <th>Tip</th>
                  <th>Status</th>
                  <th>Kreirao</th>
                  <th>Završio</th>
                  <th>Vrijeme završetka</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let task of historyTasks; trackBy: trackByTaskId">
                  <td>{{ task.date | date:'shortDate' }}</td>
                  <td *ngIf="canManageStores">{{ task.prodavnicaNaziv || task.prodavnicaBroj || task.prodavnicaId }}</td>
                  <td>
                    <div class="history-title">{{ task.title }}</div>
                    <div class="history-description" *ngIf="task.description">{{ task.description }}</div>
                  </td>
                  <td>{{ task.type === repetitiveType ? 'Ponavljajući' : 'Jednokratni' }}</td>
                  <td>
                    <nb-badge [text]="statusLabelMap[task.status] || (task.status | titlecase)"
                              [status]="task.status === 'DONE' ? 'success' : task.status === 'IN_PROGRESS' ? 'info' : 'warning'">
                    </nb-badge>
                  </td>
                  <td>{{ task.createdBy || '—' }}</td>
                  <td>{{ task.completedBy || '—' }}</td>
                  <td>{{ task.completedAt ? (task.completedAt | date:'short') : '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </ng-container>
  </nb-card-body>
</nb-card>
