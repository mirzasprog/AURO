<nb-card class="stavke-modal">
  <nb-card-header>
    {{ naslov }} - stavke
  </nb-card-header>
  <nb-card-body>
    <div class="alert alert-success" *ngIf="uspjeh">{{ uspjeh }}</div>
    <div class="alert alert-danger" *ngIf="greska">{{ greska }}</div>

    <div class="context-header">
      <div class="title-group">
        <p class="eyebrow">Pregled narudžbi</p>
        <h3 class="section-title">{{ naslov }}</h3>
        <p class="section-subtitle">Provjerite narudžbe, status i količine prije slanja.</p>
      </div>
      <div class="pill-group">
        <div class="pill strong">
          <nb-icon icon="home-outline"></nb-icon>
          <span *ngIf="rola === 'prodavnica'">Prodavnica #{{ brojProdavnice }}</span>
          <span *ngIf="rola !== 'prodavnica'">{{ trenutnaProdavnicaOznaka }}</span>
        </div>
        <div class="pill success" title="Broj stavki sa naručenom količinom">
          <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
          <span>{{ brojNarucenih }} naručenih</span>
        </div>
        <div class="pill warning" title="Broj stavki bez narudžbe">
          <nb-icon icon="alert-triangle-outline"></nb-icon>
          <span>{{ brojNenarucenih }} bez narudžbe</span>
        </div>
        <div class="pill neutral" title="Ukupno stavki u tabeli">
          <nb-icon icon="layers-outline"></nb-icon>
          <span>{{ ukupnoPrikazanih }} stavki</span>
        </div>
      </div>
    </div>

    <div class="editor-bar" *ngIf="mozeUrediti()">
      <ng-container *ngIf="rola === 'prodavnica'; else upravaControls">
        <div class="editor-field">
          <label>Prodavnica</label>
          <div class="pill">Prodavnica #{{ brojProdavnice }}</div>
        </div>
      </ng-container>
      <ng-template #upravaControls>
        <div class="editor-field full-width">
          <label>Prodavnica</label>
          <div class="input-with-actions">
            <input nbInput fullWidth placeholder="Brzi filter prodavnice" [(ngModel)]="prodavnicaFilter"
              (ngModelChange)="promijeniFiltre()" list="prodavnice-list">
            <button nbButton size="tiny" status="basic" (click)="prodavnicaFilter=''; promijeniFiltre()"
              [disabled]="!prodavnicaFilter">Reset</button>
          </div>
          <small class="text-muted">Ne mijenja podatke, već filtrira tabelu po prodavnici.</small>
        </div>
        <div class="editor-actions">
          <button nbButton size="small" status="success" (click)="exportujProdavniceBezNarudzbi()"
            [disabled]="!neaktivneProdavnice.length">
            <nb-icon icon="download-outline"></nb-icon> Prodavnice bez narudžbi
          </button>
          <small class="text-muted helper-text" *ngIf="!neaktivneProdavnice.length && !loading">
            Sve prodavnice imaju kreirane narudžbe.
          </small>
        </div>
      </ng-template>
    </div>
    <datalist id="prodavnice-list">
      <option *ngFor="let prod of dostupneProdavnice" [value]="prod"></option>
    </datalist>

    <div class="filter-bar" *ngIf="prikaziFiltre">
      <div class="filter-field">
        <label>Pretraga</label>
        <input nbInput fullWidth placeholder="Šifra, naziv ili opis" [(ngModel)]="searchTerm"
          (ngModelChange)="promijeniFiltre()">
      </div>
      <div class="filter-field">
        <label>Status narudžbe</label>
        <nb-select fullWidth [(selected)]="filterStatus" (selectedChange)="promijeniFiltre()">
          <nb-option value="sve">Sve stavke</nb-option>
          <nb-option value="naručeno">Samo naručeno</nb-option>
          <nb-option value="nenaručeno">Bez narudžbe</nb-option>
        </nb-select>
      </div>
    </div>

    <div class="legend-bar">
      <div class="legend-item legend-success">
        <span class="legend-dot legend-success-dot"></span>
        Naručeno
      </div>
      <div class="legend-item legend-danger">
        <span class="legend-dot legend-danger-dot"></span>
        Bez narudžbe
      </div>
      <div class="legend-item legend-warning">
        <nb-icon icon="alert-circle-outline" status="warning"></nb-icon>
        Izmijenjena količina
      </div>
    </div>

    <div class="table-container" *ngIf="!loading; else loadingStavke">
      <table class="stavke-table">
        <colgroup>
          <col class="col-prodavnica">
          <col class="col-sifra">
          <col class="col-naziv">
          <col class="col-bar-kod">
          <col class="col-dobavljac">
          <col class="col-akcija">
          <col class="col-as">
          <col class="col-as">
          <col class="col-as">
          <col class="col-status">
          <col class="col-opis">
          <col class="col-zaliha">
          <col class="col-kolicina">
          <col class="col-oznaka">
        </colgroup>
        <thead>
          <tr>
            <th>Prodavnica</th>
            <th>Šifra</th>
            <th>Naziv</th>
            <th>Bar kod</th>
            <th>Dobavljač</th>
            <th class="text-end">Akcijska MPC</th>
            <th class="text-end">AS SA</th>
            <th class="text-end">AS MO</th>
            <th class="text-end">AS BL</th>
            <th>Status</th>
            <th>Opis</th>
            <th class="text-end">Zaliha</th>
            <th class="text-center">Naručena količina</th>
            <th class="text-center">Izmjena</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stavka of prikazaneStavke" [ngClass]="{
              'ordered-row': (stavka.kolicina ?? 0) > 0,
              'not-ordered-row': (stavka.kolicina ?? 0) === 0
            }">
            <td class="text-nowrap">
              <span class="cell-pill">{{ stavka.prodavnica || 'N/A' }}</span>
            </td>
            <td class="mono">{{ stavka.sifra }}</td>
            <td class="naziv-cell">
              <div class="primary-text">{{ stavka.naziv }}</div>
            </td>
            <td class="mono">{{ stavka.barKod }}</td>
            <td>{{ stavka.dobavljac }}</td>
            <td class="text-end numeric">{{ stavka.akcijskaMpc | number: '1.2-2' }}</td>
            <td class="text-end numeric">{{ stavka.asSa | number: '1.0-2' }}</td>
            <td class="text-end numeric">{{ stavka.asMo | number: '1.0-2' }}</td>
            <td class="text-end numeric">{{ stavka.asBl | number: '1.0-2' }}</td>
            <td>
              <span class="status-pill" [ngClass]="statusClass(stavka.status)">{{ stavka.status || 'N/A' }}</span>
            </td>
            <td class="opis-cell">
              <div class="opis-text" [title]="stavka.opis || 'Nema opisa'">{{ stavka.opis || 'Nema opisa' }}</div>
            </td>
            <td class="text-end zaliha-cell">
              <span class="quantity-chip">{{ (stavka.zaliha === null || stavka.zaliha === undefined) ? 0 : stavka.zaliha }}</span>
            </td>
            <td class="kolicina-cell" [ngClass]="{ 'zero-order': (stavka.kolicina ?? 0) === 0, 'changed': kolicinaPromijenjena(stavka) }">
              <div class="quantity-wrapper">
                <input nbInput fullWidth type="number" step="0.01" min="0" [(ngModel)]="stavka.kolicina"
                  (ngModelChange)="onKolicinaChange()" [disabled]="!mozeUrediti()" class="kolicina-input" />
                <span class="change-pill" *ngIf="kolicinaPromijenjena(stavka)">Izmjena</span>
              </div>
            </td>
            <td class="text-center">
              <nb-icon *ngIf="!kolicinaPromijenjena(stavka)" icon="checkmark-circle-2-outline" status="success"></nb-icon>
              <nb-icon *ngIf="kolicinaPromijenjena(stavka)" icon="alert-circle-outline" status="warning"></nb-icon>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="paginator" *ngIf="filtriraneStavke.length">
        <button nbButton size="tiny" status="info" (click)="promijeniStranicu(-1)"
          [disabled]="trenutnaStranica === 1">Prethodna</button>
        <span>Stranica {{ trenutnaStranica }} / {{ ukupnoStranica }}</span>
        <button nbButton size="tiny" status="info" (click)="promijeniStranicu(1)"
          [disabled]="trenutnaStranica >= ukupnoStranica">Sljedeća</button>
      </div>
      <div class="text-center text-muted" *ngIf="!filtriraneStavke.length">Nema stavki za prikaz.</div>
    </div>
    <ng-template #loadingStavke>
      <div class="d-flex justify-content-center">
        <nb-spinner></nb-spinner>
      </div>
    </ng-template>
  </nb-card-body>
  <nb-card-footer class="col">
    <button nbButton status="danger" size="small" (click)="zatvori(false)" [disabled]="saving">Zatvori</button>
    <button nbButton status="primary" size="small" (click)="ucitajStavke()" [disabled]="saving">Osvježi</button>
    <button nbButton status="success" size="small" (click)="sacuvaj()" [disabled]="!mozeSpasiti()">Sačuvaj</button>
  </nb-card-footer>
</nb-card>
