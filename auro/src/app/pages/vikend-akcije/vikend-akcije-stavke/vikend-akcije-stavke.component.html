<nb-card class="stavke-modal">
  <nb-card-header>
    {{ naslov }} - stavke
  </nb-card-header>
  <nb-card-body>
    <div class="alert alert-success" *ngIf="uspjeh">{{ uspjeh }}</div>
    <div class="alert alert-danger" *ngIf="greska">{{ greska }}</div>

    <div class="editor-bar" *ngIf="mozeUrediti()">
      <ng-container *ngIf="rola === 'prodavnica'; else upravaControls">
        <div class="editor-field">
          <label>Prodavnica</label>
          <div class="pill">Prodavnica #{{ brojProdavnice }}</div>
        </div>
      </ng-container>
      <ng-template #upravaControls>
        <div class="editor-field full-width">
          <label>Prodavnica</label>
          <div class="input-with-actions">
            <input nbInput fullWidth placeholder="Brzi filter prodavnice" [(ngModel)]="prodavnicaFilter"
              (ngModelChange)="promijeniFiltre()" list="prodavnice-list">
            <button nbButton size="tiny" status="basic" (click)="prodavnicaFilter=''; promijeniFiltre()"
              [disabled]="!prodavnicaFilter">Reset</button>
          </div>
          <small class="text-muted">Ne mijenja podatke, već filtrira tabelu po prodavnici.</small>
        </div>
        <div class="editor-actions">
          <button nbButton size="small" status="success" (click)="exportujProdavniceBezNarudzbi()"
            [disabled]="!neaktivneProdavnice.length">
            <nb-icon icon="download-outline"></nb-icon> Prodavnice bez narudžbi
          </button>
          <small class="text-muted helper-text" *ngIf="!neaktivneProdavnice.length && !loading">
            Sve prodavnice imaju kreirane narudžbe.
          </small>
        </div>
      </ng-template>
    </div>
    <datalist id="prodavnice-list">
      <option *ngFor="let prod of dostupneProdavnice" [value]="prod"></option>
    </datalist>

    <div class="filter-bar">
      <div class="filter-field">
        <label>Pretraga</label>
        <input nbInput fullWidth placeholder="Šifra, naziv ili opis" [(ngModel)]="searchTerm"
          (ngModelChange)="promijeniFiltre()">
      </div>
      <div class="filter-field">
        <label>Status narudžbe</label>
        <nb-select fullWidth [(selected)]="filterStatus" (selectedChange)="promijeniFiltre()">
          <nb-option value="sve">Sve stavke</nb-option>
          <nb-option value="naručeno">Samo naručeno</nb-option>
          <nb-option value="nenaručeno">Bez narudžbe</nb-option>
        </nb-select>
      </div>
    </div>

    <div class="table-container" *ngIf="!loading; else loadingStavke">
      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th>Prodavnica</th>
            <th>Šifra</th>
            <th>Naziv</th>
            <th>Bar kod</th>
            <th>Dobavljač</th>
            <th class="text-end">Akcijska MPC</th>
            <th class="text-end">AS SA</th>
            <th class="text-end">AS MO</th>
            <th class="text-end">AS BL</th>
            <th>Status</th>
            <th>Opis</th>
            <th class="text-end">Zaliha</th>
            <th class="text-center">Naručena količina</th>
            <th class="text-center">***</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let stavka of prikazaneStavke" [ngClass]="{
              'ordered-row': (stavka.kolicina ?? 0) > 0,
              'not-ordered-row': (stavka.kolicina ?? 0) === 0
            }">
            <td class="text-nowrap">{{ stavka.prodavnica || 'N/A' }}</td>
            <td>{{ stavka.sifra }}</td>
            <td>{{ stavka.naziv }}</td>
            <td>{{ stavka.barKod }}</td>
            <td>{{ stavka.dobavljac }}</td>
            <td class="text-end">{{ stavka.akcijskaMpc | number: '1.2-2' }}</td>
            <td class="text-end">{{ stavka.asSa | number: '1.0-2' }}</td>
            <td class="text-end">{{ stavka.asMo | number: '1.0-2' }}</td>
            <td class="text-end">{{ stavka.asBl | number: '1.0-2' }}</td>
            <td>{{ stavka.status }}</td>
            <td>{{ stavka.opis }}</td>
            <td class="text-end">{{ (stavka.zaliha === null || stavka.zaliha === undefined) ? 0 : stavka.zaliha }}</td>
            <td class="kolicina-cell" [ngClass]="{ 'zero-order': (stavka.kolicina ?? 0) === 0 }">
              <input nbInput fullWidth type="number" step="0.01" min="0" [(ngModel)]="stavka.kolicina"
                (ngModelChange)="onKolicinaChange()" [disabled]="!mozeUrediti()" />
            </td>
            <td class="text-center">
              <nb-icon *ngIf="!kolicinaPromijenjena(stavka)" icon="checkmark-circle-2-outline" status="success"></nb-icon>
              <nb-icon *ngIf="kolicinaPromijenjena(stavka)" icon="alert-circle-outline" status="warning"></nb-icon>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="paginator" *ngIf="filtriraneStavke.length">
        <button nbButton size="tiny" status="info" (click)="promijeniStranicu(-1)"
          [disabled]="trenutnaStranica === 1">Prethodna</button>
        <span>Stranica {{ trenutnaStranica }} / {{ ukupnoStranica }}</span>
        <button nbButton size="tiny" status="info" (click)="promijeniStranicu(1)"
          [disabled]="trenutnaStranica >= ukupnoStranica">Sljedeća</button>
      </div>
      <div class="text-center text-muted" *ngIf="!filtriraneStavke.length">Nema stavki za prikaz.</div>
    </div>
    <ng-template #loadingStavke>
      <div class="d-flex justify-content-center">
        <nb-spinner></nb-spinner>
      </div>
    </ng-template>
  </nb-card-body>
  <nb-card-footer class="col">
    <button nbButton status="danger" size="small" (click)="zatvori(false)" [disabled]="saving">Zatvori</button>
    <button nbButton status="primary" size="small" (click)="ucitajStavke()" [disabled]="saving">Osvježi</button>
    <button nbButton status="success" size="small" (click)="sacuvaj()" [disabled]="!mozeSpasiti()">Sačuvaj</button>
  </nb-card-footer>
</nb-card>
