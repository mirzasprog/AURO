<div class="smjene-container">
  <!-- TOOLBAR -->
  <div class="toolbar-section">
    <div class="toolbar-left">
      <div class="field-group">
        <label>Prodavnica</label>
        <nb-select 
          *ngIf="canManageStores" 
          placeholder="Odaberite prodavnicu" 
          [(ngModel)]="selectedStoreId" 
          (selectedChange)="onStoreChange()" 
          class="select-input">
          <nb-option *ngFor="let store of stores" [value]="store.id">
            {{ store.name }}
          </nb-option>
        </nb-select>
        <div *ngIf="!canManageStores" class="selected-store">
          {{ stores[0]?.name || 'Prodavnica' }}
        </div>
      </div>

      <div class="field-group">
        <label>Sedmica od</label>
        <input 
          nbInput 
          type="date" 
          [(ngModel)]="weekPicker" 
          (change)="onWeekChange(weekPicker)" 
          class="date-input" />
      </div>
    </div>

    <div class="toolbar-right">
      <button *ngIf="this.role == 'prodavnica'"
        nbButton 
        status="primary" 
        size="small" 
        (click)="openAddShift()" 
        [disabled]="!canEditShifts" 
        class="action-btn">
        <nb-icon icon="plus-outline"></nb-icon>
        Nova smjena
      </button>

      <div class="export-group">
        <nb-select [(ngModel)]="exportFormat" style="margin-left: 10px;">
          <nb-option value="xlsx">XLSX</nb-option>
          <nb-option value="csv">CSV</nb-option>
        </nb-select>
        <button  
          nbButton 
          status="success" 
          size="small" 
          (click)="exportShifts()" 
          class="action-btn">
          <nb-icon icon="download-outline"></nb-icon>
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <nb-tabset class="tabs-section" (changeTab)="onTabChange($event.tabTitle)">
    
    <!-- Sedmiƒçni PREGLED -->
    <nb-tab tabTitle="üìÜ Sedmiƒçni Pregled">
      <div class="tab-content">
        <div *ngIf="loading" class="loading-state">
          <nb-spinner size="large"></nb-spinner>
          <p>Uƒçitavanje smjena...</p>
        </div>

        <div *ngIf="!loading" class="calendar-view">
          <div class="calendar-grid">
            <div
              *ngFor="let daySchedule of daySchedules"
              class="day-card"
              role="button"
              tabindex="0"
              (dblclick)="openDayDetails(daySchedule)"
              (keydown.enter)="openDayDetails(daySchedule)">
              
              <div class="day-header">
                <h3>{{ daySchedule.dayName }}</h3>
                <span class="day-date">{{ daySchedule.date | date: 'dd.MM' }}</span>
              </div>

              <div class="shifts-container">
                <!-- PRVA SMJENA -->
                <div class="shift-section">
                  <div class="shift-title">‚è∞ Prva smjena</div>
                  <div class="shift-list">
                    <div *ngIf="daySchedule.shiftsFirstShift.length === 0" class="empty-slot">
                      <span class="empty-text">Nema zaposlenih</span>
                    </div>
                    <div *ngFor="let shift of daySchedule.shiftsFirstShift" class="shift-item">
                      <div class="shift-info">
                        <div class="employee-name">{{ shift.employeeName }}</div>
                        <div class="shift-time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- DRUGA SMJENA -->
                <div class="shift-section">
                  <div class="shift-title">‚è∞ Druga smjena</div>
                  <div class="shift-list">
                    <div *ngIf="daySchedule.shiftsSecondShift.length === 0" class="empty-slot">
                      <span class="empty-text">Nema zaposlenih</span>
                    </div>
                    <div *ngFor="let shift of daySchedule.shiftsSecondShift" class="shift-item">
                      <div class="shift-info">
                        <div class="employee-name">{{ shift.employeeName }}</div>
                        <div class="shift-time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="day-hint">Dvaput kliknite za detaljni pregled</div>
            </div>
          </div>
        </div>
      </div>
    </nb-tab>

    <!-- DNEVNI PREGLED -->
    <nb-tab tabTitle="üìÖ Dnevni Pregled">
      <div class="tab-content">
        <div class="daily-header">
          <div class="field-group">
            <label>Odaberite datum</label>
            <input 
              nbInput 
              type="date" 
              [ngModel]="formatDateInput(selectedDay)" 
              (ngModelChange)="onDayChange($event)" 
              class="date-input" />
          </div>
        </div>

        <div *ngIf="dailyShifts.length === 0" class="empty-state">
          <nb-icon icon="inbox-outline" size="large"></nb-icon>
          <p>Nema smjena za odabrani dan</p>
        </div>

        <div *ngIf="dailyShifts.length" class="daily-shifts">
          <div *ngFor="let shift of dailyShifts" class="daily-shift-card">
            <div class="shift-main-info">
              <div class="shift-header">
                <h4>{{ shift.employeeName || ('#' + shift.employeeId) }}</h4>
                <span class="shift-badge" [ngClass]="'status-' + (shift.status | lowercase)">
                  {{ shift.status }}
                </span>
              </div>
              <div class="shift-details">
                <span class="detail">
                  <nb-icon icon="clock-outline"></nb-icon>
                  {{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}
                </span>
                <span class="detail">
                  <nb-icon icon="briefcase-outline"></nb-icon>
                  {{ shift.shiftType }}
                </span>
                <span *ngIf="shift.departmentId" class="detail">
                  <nb-icon icon="layers-outline"></nb-icon>
                  Odjel {{ shift.departmentId }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nb-tab>

    <!-- MJESEƒåNI PREGLED -->
    <nb-tab tabTitle="üìä Mjeseƒçni Pregled">
      <div class="tab-content">
        <div *ngIf="monthLoading" class="loading-state">
          <nb-spinner size="large"></nb-spinner>
          <p>Uƒçitavanje mjeseƒçnog pregleda...</p>
        </div>

        <div *ngIf="!monthLoading" class="month-calendar-wrapper">
          <div class="month-header">
            <button nbButton status="basic" size="small" (click)="prevMonth()" class="month-nav-btn">
              <nb-icon icon="chevron-left-outline"></nb-icon>
            </button>
            <div class="month-title-section">
              <h3>{{ currentMonth | date: 'MMMM yyyy' | uppercase }}</h3>
              <p class="month-subtitle">Pregled smjena po danima u mjesecu</p>
            </div>
            <button nbButton status="basic" size="small" (click)="nextMonth()" class="month-nav-btn">
              <nb-icon icon="chevron-right-outline"></nb-icon>
            </button>
          </div>

          <div *ngIf="monthShifts.length === 0" class="empty-state">
            <nb-icon icon="calendar-outline" size="large"></nb-icon>
            <p>Nema smjena u odabranom mjesecu</p>
          </div>

          <div class="month-weekdays">
            <div *ngFor="let label of weekDayLabels" class="weekday-label">{{ label }}</div>
          </div>

          <div class="month-grid">
            <div
              *ngFor="let day of monthCalendarDays"
              class="month-day"
              [class.outside]="!day.inMonth"
              role="button"
              tabindex="0"
              (dblclick)="openDayDetails(day.schedule)"
              (keydown.enter)="openDayDetails(day.schedule)">
              
              <div class="month-date">{{ day.date | date: 'd' }}</div>
              <div class="month-shift-preview">
                <div class="shift-preview shift-preview--first">
                  <span class="label">Prva</span>
                  <span class="value">{{ formatShiftPreview(day.schedule.shiftsFirstShift) }}</span>
                </div>
                <div class="shift-preview shift-preview--second">
                  <span class="label">Druga</span>
                  <span class="value">{{ formatShiftPreview(day.schedule.shiftsSecondShift) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nb-tab>

  </nb-tabset>

  <!-- DAY DETAILS MODAL -->
  <ng-template #dayDetailsDialog let-data let-ref="dialogRef">
    <div class="day-details-modal">
      <div class="modal-header">
        <div>
          <h3>{{ data.schedule.dayName }}</h3>
          <span>{{ data.schedule.date | date: 'dd.MM.yyyy' }}</span>
        </div>
        <button 
          nbButton 
          ghost 
          status="basic" 
          size="tiny" 
          (click)="ref.close()" 
          aria-label="Zatvori">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-column">
          <h4>üë§ Prva smjena</h4>
          <div *ngIf="data.schedule.shiftsFirstShift.length === 0" class="modal-empty">
            Nema zaposlenih
          </div>
          <div *ngFor="let shift of data.schedule.shiftsFirstShift" class="modal-shift">
            <span class="name">{{ shift.employeeName || ('#' + shift.employeeId) }}</span>
            <span class="time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</span>
          </div>
        </div>
        <div class="modal-column">
          <h4>üë§ Druga smjena</h4>
          <div *ngIf="data.schedule.shiftsSecondShift.length === 0" class="modal-empty">
            Nema zaposlenih
          </div>
          <div *ngFor="let shift of data.schedule.shiftsSecondShift" class="modal-shift">
            <span class="name">{{ shift.employeeName || ('#' + shift.employeeId) }}</span>
            <span class="time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

</div>