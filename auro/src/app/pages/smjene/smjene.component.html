<div class="smjene-container">
  <!-- Header Banner -->
  <div class="header-section">
    <div class="header-content">
      <h1>Upravljanje smjenama</h1>
      <p class="subtitle">Efikasno planiranje i pregled raspokupljenih smjena</p>
    </div>
    <div class="role-banner" *ngIf="!canEditShifts">
      <nb-icon icon="info-outline"></nb-icon>
      <span>Rola uprava ima samo pregled postojećih smjena.</span>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar-section">
    <div class="toolbar-left">
      <div class="field-group">
        <label>Prodavnica</label>
        <nb-select *ngIf="canManageStores" placeholder="Odaberite prodavnicu" [(ngModel)]="selectedStoreId" (selectedChange)="onStoreChange()" class="select-input">
          <nb-option *ngFor="let store of stores" [value]="store.id">
            {{ store.name }}
          </nb-option>
        </nb-select>
        <div *ngIf="!canManageStores" class="selected-store">
          {{ stores[0]?.name || 'Prodavnica' }}
        </div>
      </div>

      <div class="field-group">
        <label>Sedmica od</label>
        <input nbInput type="date" [(ngModel)]="weekPicker" (change)="onWeekChange(weekPicker)" class="date-input" />
      </div>
    </div>

    <div class="toolbar-right">
      <button nbButton status="primary" size="small" (click)="openAddShift()" [disabled]="!canEditShifts" class="action-btn">
        <nb-icon icon="plus-outline"></nb-icon>
        Nova smjena
      </button>
      <button nbButton status="info" size="small" (click)="openCopyWeek()" [disabled]="!canEditShifts" class="action-btn">
        <nb-icon icon="copy-outline"></nb-icon>
        Kopiraj sedmicu
      </button>
      <div class="export-group">
        <nb-select [(ngModel)]="exportFormat" class="format-select">
          <nb-option value="xlsx">XLSX</nb-option>
          <nb-option value="csv">CSV</nb-option>
        </nb-select>
        <button nbButton status="basic" size="small" (click)="exportShifts()" class="action-btn">
          <nb-icon icon="download-outline"></nb-icon>
          Export
        </button>
      </div>
      <div class="toolbar-hint">
        Smjene se spremaju odmah kao <strong>Draft</strong> i odmah su vidljive u tabeli.
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <nb-tabset class="tabs-section">
    <!-- Tjedni pregled -->
    <nb-tab tabTitle="Tjedni pregled">
      <ng-template nbTabContent>
        <div class="tab-content">
          <!-- Loading -->
          <div *ngIf="loading" class="loading-state">
            <nb-spinner size="large"></nb-spinner>
            <p>Učitavanje smjena...</p>
          </div>

          <!-- Calendar View -->
          <div *ngIf="!loading" class="calendar-view">
            <div class="calendar-grid">
              <div *ngFor="let daySchedule of daySchedules" class="day-card">
                <div class="day-header">
                  <h3>{{ daySchedule.dayName }}</h3>
                  <span class="day-date">{{ daySchedule.date | date: 'dd.MM' }}</span>
                </div>

                <div class="shifts-container">
                  <!-- Prva smjena -->
                  <div class="shift-section">
                    <div class="shift-title">Prva smjena</div>
                    <div class="shift-list">
                      <div *ngIf="daySchedule.shiftsFirstShift.length === 0" class="empty-slot">
                        <span class="empty-text">Nema zaposlenih</span>
                      </div>
                      <div *ngFor="let shift of daySchedule.shiftsFirstShift" class="shift-item">
                        <div class="shift-info">
                          <div class="employee-name">{{ shift.employeeName }}</div>
                          <div class="shift-time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</div>
                        </div>
                        <div class="shift-actions">
                          <button nbButton ghost size="tiny" status="info" (click)="openEditShift(shift)" [disabled]="!canEditShifts" nbTooltip="Uredi">
                            <nb-icon icon="edit-2-outline"></nb-icon>
                          </button>
                          <button nbButton ghost size="tiny" status="danger" (click)="deleteShift(shift)" [disabled]="!canEditShifts" nbTooltip="Obriši">
                            <nb-icon icon="trash-2-outline"></nb-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Druga smjena -->
                  <div class="shift-section">
                    <div class="shift-title">Druga smjena</div>
                    <div class="shift-list">
                      <div *ngIf="daySchedule.shiftsSecondShift.length === 0" class="empty-slot">
                        <span class="empty-text">Nema zaposlenih</span>
                      </div>
                      <div *ngFor="let shift of daySchedule.shiftsSecondShift" class="shift-item">
                        <div class="shift-info">
                          <div class="employee-name">{{ shift.employeeName }}</div>
                          <div class="shift-time">{{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}</div>
                        </div>
                        <div class="shift-actions">
                          <button nbButton ghost size="tiny" status="info" (click)="openEditShift(shift)" [disabled]="!canEditShifts" nbTooltip="Uredi">
                            <nb-icon icon="edit-2-outline"></nb-icon>
                          </button>
                          <button nbButton ghost size="tiny" status="danger" (click)="deleteShift(shift)" [disabled]="!canEditShifts" nbTooltip="Obriši">
                            <nb-icon icon="trash-2-outline"></nb-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </nb-tab>

    <!-- Dnevni pregled -->
    <nb-tab tabTitle="Dnevni pregled">
      <ng-template nbTabContent>
        <div class="tab-content">
          <div class="daily-header">
            <div class="field-group">
              <label>Odaberite datum</label>
              <input nbInput type="date" [ngModel]="formatDateInput(selectedDay)" (ngModelChange)="onDayChange($event)" class="date-input" />
            </div>
          </div>

          <div *ngIf="dailyShifts.length === 0" class="empty-state">
            <nb-icon icon="inbox-outline" size="large"></nb-icon>
            <p>Nema smjena za odabrani dan</p>
          </div>

          <div *ngIf="dailyShifts.length" class="daily-shifts">
            <div *ngFor="let shift of dailyShifts" class="daily-shift-card">
              <div class="shift-main-info">
                <div class="shift-header">
                  <h4>{{ shift.employeeName || ('#' + shift.employeeId) }}</h4>
                  <span class="shift-badge" [ngClass]="'status-' + (shift.status | lowercase)">{{ shift.status }}</span>
                </div>
                <div class="shift-details">
                  <span class="detail">
                    <nb-icon icon="clock-outline"></nb-icon>
                    {{ shift.startTime | slice:0:5 }} - {{ shift.endTime | slice:0:5 }}
                  </span>
                  <span class="detail">
                    <nb-icon icon="briefcase-outline"></nb-icon>
                    {{ shift.shiftType }}
                  </span>
                  <span *ngIf="shift.departmentId" class="detail">
                    <nb-icon icon="layers-outline"></nb-icon>
                    Odjel {{ shift.departmentId }}
                  </span>
                </div>
              </div>
              <div class="shift-actions-right">
                <button nbButton status="info" size="small" (click)="openEditShift(shift)" [disabled]="!canEditShifts">
                  Uredi
                </button>
                <button nbButton status="danger" size="small" (click)="deleteShift(shift)" [disabled]="!canEditShifts">
                  Obriši
                </button>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </nb-tab>

    <!-- Mjesečni pregled -->
    <nb-tab tabTitle="Mjesečni pregled">
      <ng-template nbTabContent>
        <div class="tab-content">
          <div *ngIf="monthLoading" class="loading-state">
            <nb-spinner size="large"></nb-spinner>
            <p>Učitavanje mjesečnog pregleda...</p>
          </div>

          <div *ngIf="!monthLoading">
            <div *ngIf="monthSummary.length === 0" class="empty-state">
              <nb-icon icon="calendar-outline" size="large"></nb-icon>
              <p>Nema smjena u odabranom mjesecu</p>
            </div>

            <div *ngIf="monthSummary.length" class="monthly-stats">
              <div *ngFor="let day of monthSummary" class="stat-card">
                <div class="stat-date">{{ day.date | date: 'dd.MM.yyyy' }}</div>
                <div class="stat-count">{{ day.count }}</div>
                <div class="stat-label">smjena</div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </nb-tab>

    <!-- Zahtjevi -->
    <nb-tab tabTitle="Zahtjevi">
      <ng-template nbTabContent>
        <div class="tab-content">
          <div *ngIf="requestsLoading" class="loading-state">
            <nb-spinner size="large"></nb-spinner>
            <p>Učitavanje zahtjeva...</p>
          </div>

          <div *ngIf="!requestsLoading">
            <div *ngIf="requests.length === 0" class="empty-state">
              <nb-icon icon="inbox-outline" size="large"></nb-icon>
              <p>Nema zahtjeva</p>
            </div>

            <div *ngIf="requests.length" class="requests-list">
              <div *ngFor="let request of requests" class="request-card">
                <div class="request-header">
                  <div class="request-employee">
                    <h4>{{ request.employeeName || ('#' + request.employeeId) }}</h4>
                    <span class="request-type">{{ request.type }}</span>
                  </div>
                  <span class="request-badge" [ngClass]="'status-' + (request.status | lowercase)">{{ request.status }}</span>
                </div>

                <div class="request-body">
                  <div class="request-field">
                    <label>Datum:</label>
                    <span>{{ request.requestedDate | date: 'dd.MM.yyyy' }}</span>
                  </div>
                  <div class="request-field">
                    <label>Poruka:</label>
                    <span>{{ request.message }}</span>
                  </div>
                  <div class="request-field">
                    <label>Napomena menadžera:</label>
                    <textarea nbInput [(ngModel)]="request.managerNote" [disabled]="!canManageRequests" placeholder="Unesite napomenu..."></textarea>
                  </div>
                </div>

                <div class="request-actions">
                  <button nbButton status="success" (click)="approveRequest(request)" [disabled]="!canManageRequests">
                    <nb-icon icon="checkmark-outline"></nb-icon>
                    Odobri
                  </button>
                  <button nbButton status="danger" (click)="rejectRequest(request)" [disabled]="!canManageRequests">
                    <nb-icon icon="close-outline"></nb-icon>
                    Odbij
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </nb-tab>
  </nb-tabset>
</div>
