<div class="dialog-container">
  <div class="dialog-header">
    <h2>{{ context.title }}</h2>
    <button nbButton ghost status="basic" (click)="close()" class="close-btn">
      <nb-icon icon="close-outline"></nb-icon>
    </button>
  </div>

  <div class="dialog-body">
    <!-- Edit Mode - Single Shift Form -->
    <ng-container *ngIf="isEditMode; else bulkTemplate">
      <form [formGroup]="form" class="form-grid">
        <!-- Store Selection -->
        <div class="form-field full-width" *ngIf="canSelectStore">
          <label>Prodavnica</label>
          <nb-select formControlName="storeId" placeholder="Odaberite prodavnicu" fullWidth>
            <nb-option *ngFor="let store of stores" [value]="store.id">
              {{ store.name }}
            </nb-option>
          </nb-select>
        </div>

        <!-- Employee Selection -->
        <div class="form-field full-width">
          <label>Zaposlenik</label>
          <nb-select formControlName="employeeId" placeholder="Odaberite zaposlenika" fullWidth>
            <nb-option *ngFor="let emp of employees" [value]="emp.employeeId">
              {{ emp.employeeName }}
            </nb-option>
          </nb-select>
          <div *ngIf="form.get('employeeId')?.touched && form.get('employeeId')?.invalid" class="error-message">
            Obavezno polje
          </div>
        </div>

        <!-- Shift Date -->
        <div class="form-field">
          <label>Datum</label>
          <input nbInput type="date" formControlName="shiftDate" />
          <div *ngIf="form.get('shiftDate')?.touched && form.get('shiftDate')?.invalid" class="error-message">
            Obavezno polje
          </div>
        </div>

        <!-- Start Time -->
        <div class="form-field">
          <label>Početak</label>
          <input nbInput type="time" formControlName="startTime" />
          <div *ngIf="form.get('startTime')?.touched && form.get('startTime')?.invalid" class="error-message">
            Obavezno polje
          </div>
        </div>

        <!-- End Time -->
        <div class="form-field">
          <label>Kraj</label>
          <input nbInput type="time" formControlName="endTime" />
          <div *ngIf="form.get('endTime')?.touched && form.get('endTime')?.invalid" class="error-message">
            Obavezno polje
          </div>
        </div>

        <!-- Break Minutes -->
        <div class="form-field">
          <label>Pauza (min)</label>
          <input nbInput type="number" formControlName="breakMinutes" min="0" />
        </div>

        <!-- Shift Type -->
        <div class="form-field">
          <label>Tip smjene</label>
          <nb-select formControlName="shiftType" placeholder="Odaberite tip" fullWidth>
            <nb-option *ngFor="let type of shiftTypes" [value]="type">{{ type }}</nb-option>
          </nb-select>
        </div>

        <!-- Department -->
        <div class="form-field">
          <label>Odjel</label>
          <input nbInput type="number" formControlName="departmentId" placeholder="ID odjela" />
        </div>

        <!-- Status -->
        <div class="form-field">
          <label>Status</label>
          <nb-select formControlName="status" fullWidth>
            <nb-option *ngFor="let status of shiftStatuses" [value]="status">{{ status }}</nb-option>
          </nb-select>
        </div>

        <!-- Note -->
        <div class="form-field full-width">
          <label>Napomena</label>
          <textarea nbInput rows="3" formControlName="note" placeholder="Unesite napomenu..."></textarea>
        </div>
      </form>
    </ng-container>

    <!-- Bulk Mode - Multiple Shifts -->
    <ng-template #bulkTemplate>
      <form [formGroup]="bulkForm" class="bulk-form">
        <!-- Header Section -->
        <div class="form-section">
          <h3 class="section-title">Opće postavke</h3>

          <div class="form-grid">
            <!-- Store Selection -->
            <div class="form-field full-width" *ngIf="canSelectStore">
              <label>Prodavnica</label>
              <nb-select formControlName="storeId" placeholder="Odaberite prodavnicu" fullWidth>
                <nb-option *ngFor="let store of stores" [value]="store.id">
                  {{ store.name }}
                </nb-option>
              </nb-select>
            </div>

            <!-- Date Range -->
            <div class="form-field">
              <label>Datum od</label>
              <input nbInput type="date" formControlName="startDate" [min]="minDate" [max]="maxDate" />
            </div>

            <div class="form-field">
              <label>Datum do</label>
              <input nbInput type="date" formControlName="endDate" [min]="minDate" [max]="maxDate" />
            </div>
          </div>

          <!-- Shift Times -->
          <div class="shift-times-container">
            <div class="shift-time-block">
              <h4>Prva smjena</h4>
              <div class="form-grid">
                <div class="form-field">
                  <label>Od</label>
                  <input nbInput type="time" formControlName="firstStart" />
                </div>
                <div class="form-field">
                  <label>Do</label>
                  <input nbInput type="time" formControlName="firstEnd" />
                </div>
              </div>
            </div>

            <div class="shift-time-block">
              <h4>Druga smjena</h4>
              <div class="form-grid">
                <div class="form-field">
                  <label>Od</label>
                  <input nbInput type="time" formControlName="secondStart" />
                </div>
                <div class="form-field">
                  <label>Do</label>
                  <input nbInput type="time" formControlName="secondEnd" />
                </div>
              </div>
            </div>
          </div>

          <p class="helper-text">Smjene se mogu unositi za raspon do 10 dana unaprijed</p>
        </div>

        <!-- Employees Table -->
        <div class="form-section">
          <h3 class="section-title">Odaberite zaposlenike</h3>

          <div *ngIf="loading" class="loading-message">
            <nb-spinner size="small"></nb-spinner>
            <span>Učitavanje zaposlenika...</span>
          </div>

          <div class="table-container" *ngIf="!loading">
            <table class="employees-table">
              <thead>
                <tr>
                  <th>IDHR</th>
                  <th>Ime</th>
                  <th>Prezime</th>
                  <th>Prva smjena</th>
                  <th>Druga smjena</th>
                  <th>Custom</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let item of pagedEmployees; let idx = index">
                  <!-- Employee Row -->
                  <tr class="employee-row">
                    <td class="cell-id">{{ item.employee.brojIzDESa || item.employee.employeeId || '-' }}</td>
                    <td class="cell-name">{{ item.employee.firstName || item.employee.ime || '-' }}</td>
                    <td class="cell-name">{{ item.employee.lastName || item.employee.prezime || '-' }}</td>
                    <td class="cell-action">
                      <button
                        nbButton
                        size="tiny"
                        type="button"
                        [status]="item.choice === 'first' ? 'primary' : 'basic'"
                        (click)="selectChoice(item, 'first')"
                        class="choice-btn">
                        ✓ Prva
                      </button>
                    </td>
                    <td class="cell-action">
                      <button
                        nbButton
                        size="tiny"
                        type="button"
                        [status]="item.choice === 'second' ? 'primary' : 'basic'"
                        (click)="selectChoice(item, 'second')"
                        class="choice-btn">
                        ✓ Druga
                      </button>
                    </td>
                    <td class="cell-action">
                      <button
                        nbButton
                        size="tiny"
                        type="button"
                        [status]="item.choice === 'custom' ? 'info' : 'basic'"
                        (click)="selectChoice(item, 'custom')"
                        class="choice-btn">
                        ⚙ Custom
                      </button>
                    </td>
                  </tr>

                  <!-- Custom Details Row -->
                  <tr *ngIf="item.choice === 'custom'" class="custom-details-row">
                    <td colspan="6">
                      <div class="custom-inputs">
                        <div class="form-field">
                          <label>Datum od</label>
                          <input nbInput type="date" [min]="minDate" [max]="maxDate" [(ngModel)]="item.customStartDate" [ngModelOptions]="{standalone: true}" />
                        </div>
                        <div class="form-field">
                          <label>Datum do</label>
                          <input nbInput type="date" [min]="minDate" [max]="maxDate" [(ngModel)]="item.customEndDate" [ngModelOptions]="{standalone: true}" />
                        </div>
                        <div class="form-field">
                          <label>Vrijeme od</label>
                          <input nbInput type="time" [(ngModel)]="item.customStartTime" [ngModelOptions]="{standalone: true}" />
                        </div>
                        <div class="form-field">
                          <label>Vrijeme do</label>
                          <input nbInput type="time" [(ngModel)]="item.customEndTime" [ngModelOptions]="{standalone: true}" />
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-controls">
            <button nbButton type="button" size="small" status="basic" (click)="previousPage()" [disabled]="currentPage === 1">
              ← Prethodna
            </button>
            <span class="page-info">Stranica {{ currentPage }} od {{ totalPages }}</span>
            <button nbButton type="button" size="small" status="basic" (click)="nextPage()" [disabled]="currentPage === totalPages">
              Sljedeća →
            </button>
          </div>
        </div>

        <!-- Validation Message -->
        <div *ngIf="validationMessage" class="validation-alert">
          <nb-icon icon="alert-circle-outline"></nb-icon>
          <span>{{ validationMessage }}</span>
        </div>
      </form>
    </ng-template>
  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <button nbButton status="basic" (click)="close()" size="medium">
      Odustani
    </button>
    <button nbButton status="primary" (click)="submit()" size="medium" class="submit-btn">
      <nb-icon icon="checkmark-outline"></nb-icon>
      Sačuvaj
    </button>
  </div>
</div>