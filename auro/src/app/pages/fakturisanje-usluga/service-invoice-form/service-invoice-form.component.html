<nb-card [nbSpinner]="loading">
  <nb-card-header class="form-header">
    <div class="title-stack">
      <div class="title h6 mb-0">{{ fakturaId ? 'Uredi fakturu' : 'Nova faktura' }}</div>
      <small class="subtitle">Podaci o kupcu i stavkama usluga u ravnoteži</small>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <button nbButton status="info" size="small" ghost *ngIf="fakturaId" [routerLink]="['/pages/fakturisanje-usluga', fakturaId, 'print']" target="_blank">
        <nb-icon icon="printer-outline"></nb-icon>
        Štampa
      </button>
      <button nbButton status="primary" size="small" (click)="sacuvaj()" [disabled]="spremanje" hero>
        <nb-icon icon="save-outline"></nb-icon>
        Sačuvaj
      </button>
    </div>
  </nb-card-header>
  <nb-card-body>
    <form [formGroup]="forma">
      <div class="row g-4">
        <div class="col-md-6">
          <nb-card class="glass-card">
            <nb-card-header>Podaci o kupcu</nb-card-header>
            <nb-card-body>
              <div class="form-grid">
                <div class="full-span">
                  <label>Ime/Naziv *</label>
                  <input nbInput size="small" fullWidth formControlName="customerName" placeholder="Kupac">
                </div>
                <div class="full-span">
                  <label>Adresa</label>
                  <input nbInput size="small" fullWidth formControlName="customerAddress" placeholder="Ulica i broj">
                </div>
                <div>
                  <label>Grad</label>
                  <input nbInput size="small" fullWidth formControlName="customerCity" placeholder="Grad">
                </div>
                <div>
                  <label>Država</label>
                  <input nbInput size="small" fullWidth formControlName="customerCountry" placeholder="Država">
                </div>
                <div>
                  <label>PDV broj</label>
                  <input nbInput size="small" fullWidth formControlName="customerTaxId" placeholder="PDV/Porezni broj">
                </div>
                <div>
                  <label>ID kupca</label>
                  <input nbInput size="small" fullWidth formControlName="customerId" type="number" placeholder="Opcionalno">
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
        <div class="col-md-6">
          <nb-card class="glass-card">
            <nb-card-header>Podaci o fakturi</nb-card-header>
            <nb-card-body>
              <div class="form-grid">
                <div>
                  <label>Broj fakture</label>
                  <input nbInput size="small" fullWidth formControlName="invoiceNumber" placeholder="Ostavite prazno za automatski broj">
                </div>
                <div>
                  <label>Status</label>
                  <input nbInput size="small" fullWidth formControlName="status" placeholder="Status">
                </div>
                <div>
                  <label>Datum fakture *</label>
                  <input nbInput size="small" fullWidth formControlName="invoiceDate" [nbDatepicker]="pickerDatum">
                  <nb-datepicker #pickerDatum></nb-datepicker>
                </div>
                <div>
                  <label>Datum dospijeća *</label>
                  <input nbInput size="small" fullWidth formControlName="dueDate" [nbDatepicker]="pickerDue">
                  <nb-datepicker #pickerDue></nb-datepicker>
                </div>
                <div>
                  <label>Valuta *</label>
                  <nb-select size="small" fullWidth placeholder="Valuta" formControlName="currency">
                    <nb-option *ngFor="let valuta of valute" [value]="valuta">{{ valuta }}</nb-option>
                  </nb-select>
                </div>
                <div>
                  <label>Napomena</label>
                  <textarea nbInput size="small" fullWidth formControlName="notes" rows="2" placeholder="Napomena"></textarea>
                </div>
                <div class="full-span mt-2">
                  <div class="d-flex justify-content-between gap-3 fw-bold summary-line">
                    <div class="chip">Osnovica: {{ forma.get('subtotalAmount')?.value | number:'1.2-2' }}</div>
                    <div class="chip">PDV: {{ forma.get('taxAmount')?.value | number:'1.2-2' }}</div>
                    <div class="chip accent">Ukupno: {{ forma.get('totalAmount')?.value | number:'1.2-2' }}</div>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
      </div>

      <nb-card size="small" class="mt-3 line-card">
        <nb-card-header class="d-flex justify-content-between align-items-center">
          <span>Stavke usluga</span>
          <button nbButton size="small" status="primary" (click)="dodajStavku()" hero>
            <nb-icon icon="plus"></nb-icon>
            Dodaj stavku
          </button>
        </nb-card-header>
        <nb-card-body>
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Opis</th>
                  <th>Količina</th>
                  <th>Jedinična cijena</th>
                  <th>Stopa PDV (%)</th>
                  <th>Ukupno bez PDV</th>
                  <th>PDV</th>
                  <th>Ukupno s PDV</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stavka of stavke.controls; index as i" [formGroup]="stavka">
                  <td class="text-center fw-semibold">{{ i + 1 }}</td>
                  <td><input nbInput size="small" fullWidth formControlName="description" placeholder="Naziv usluge"></td>
                  <td><input nbInput size="small" fullWidth type="number" min="0.01" step="0.01" formControlName="quantity"></td>
                  <td><input nbInput size="small" fullWidth type="number" min="0" step="0.01" formControlName="unitPrice"></td>
                  <td><input nbInput size="small" fullWidth type="number" min="0" step="0.01" formControlName="taxRate"></td>
                  <td class="text-end">{{ (stavka.value.quantity * stavka.value.unitPrice) | number:'1.2-2' }}</td>
                  <td class="text-end">{{ (stavka.value.quantity * stavka.value.unitPrice * stavka.value.taxRate/100) | number:'1.2-2' }}</td>
                  <td class="text-end">{{ (stavka.value.quantity * stavka.value.unitPrice * (1 + stavka.value.taxRate/100)) | number:'1.2-2' }}</td>
                  <td class="text-center">
                    <button nbButton status="danger" size="small" (click)="ukloniStavku(i)" [disabled]="stavke.length === 1" ghost>
                      <nb-icon icon="trash-2-outline"></nb-icon>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-end gap-4 fw-bold mt-3 totals">
            <div>Osnovica: {{ forma.get('subtotalAmount')?.value | number:'1.2-2' }} {{ forma.get('currency')?.value }}</div>
            <div>PDV: {{ forma.get('taxAmount')?.value | number:'1.2-2' }} {{ forma.get('currency')?.value }}</div>
            <div>Ukupno: {{ forma.get('totalAmount')?.value | number:'1.2-2' }} {{ forma.get('currency')?.value }}</div>
          </div>
        </nb-card-body>
      </nb-card>
    </form>
  </nb-card-body>
</nb-card>
