<div class="chatbot-wrapper" [class.open]="isOpen">
  <button
    class="chatbot-toggle"
    cdkDrag
    cdkDragBoundary="body"
    (click)="toggleChat()"
    aria-label="Otvori K360 chatbot"
  >
    <span class="avatar-ring">
      <img src="assets/images/KONZUM.png" alt="K360 avatar" />
    </span>
    <span class="toggle-label">Konzum360 AI Chatbot</span>
  </button>

  <nb-card *ngIf="isOpen" class="chatbot-card" aria-live="polite" cdkDrag cdkDragBoundary="body">
    <nb-card-header cdkDragHandle>
      <div class="header-content">
        <div class="brand">
          <span class="brand-avatar">
            <img src="assets/images/KONZUM.png" alt="K360 avatar" />
          </span>
          <div>
            <div class="title">Konzum360 AI Chatbot</div>
          </div>
        </div>
        <div class="header-actions">
          <nb-badge text="Demo" status="info" position="top right"></nb-badge>
          <button nbButton outline size="small" ghost  status="basic" (click)="toggleChat()" aria-label="Zatvori prozor">
           <nb-icon icon="close-outline"></nb-icon>
          </button>
        </div>
      </div>
    </nb-card-header>
    <nb-card-body>
      <!--Prijedlog pitanja-->
      <div class="col" *ngIf="suggestions.length">
          <div class="suggestion-title">Brzi prijedlog</div>
          <div class="suggestion-list">
            <button
              nbButton
              size="small"
              appearance="ghost"
              status="danger"
              *ngFor="let suggestion of suggestions"
              (click)="useSuggestion(suggestion)">
              {{ suggestion }}
            </button>
          </div>
        </div>
        <hr>
        <!--Chat-->
        <div class="col">
        <div class="chat-window">
          <div
            *ngFor="let message of conversation"
            class="message"
            [class.from-user]="message.from === 'user'"
            [class.from-bot]="message.from === 'bot'">
            <div class="message-meta">{{ message.timestamp | date:'HH:mm' }}</div>
            <div class="bubble">{{ message.text }}</div>
          </div>
        </div>
        </div>

    </nb-card-body>
    <nb-card-footer>
      <div class="input-row">
        <input
          nbInput
          fullWidth
          placeholder="Postavi pitanje o Konzum 360 aplikaciji"
          [(ngModel)]="currentQuestion"
          (keyup.enter)="submitQuestion()"
          name="chatQuestion"
          autocomplete="off"
        />
        <div class="file-input">
          <input
            type="file"
            #fileInput
            (change)="onFilesSelected($event)"
            accept=".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg"
            multiple
            aria-label="Dodaj dokument za pitanje"
          />
          <nb-icon icon="attach-outline"></nb-icon>
        </div>
        <button nbButton status="primary" (click)="submitQuestion()" [disabled]="isSending">{{ isSending ? 'Slanje...' : 'Pošalji' }}</button>
      </div>
      <div *ngIf="selectedFiles.length" class="attachment-list">
        <div *ngFor="let file of selectedFiles; let i = index" class="attachment-item">
          <nb-icon icon="file-text-outline"></nb-icon>
          <span class="attachment-name">{{ file.name }}</span>
          <button nbButton ghost size="tiny" status="basic" (click)="removeFile(i)" aria-label="Ukloni fajl">
            <nb-icon icon="close-outline"></nb-icon>
          </button>
        </div>
      </div>
      <div class="footer-note">Ako odgovor ne postoji, asistent će te uputiti da kontaktiraš IT službu.</div>
    </nb-card-footer>
  </nb-card>
</div>
